# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```bash
npm run dev          # Start Next.js dev server (localhost:3000)
npm run build        # Production build (runs tsc + Next.js build)
npm run lint         # ESLint (next/core-web-vitals + next/typescript)
npm run test         # Run Vitest once
npm run test:watch   # Vitest in watch mode
npm run seed:users   # Seed 3 default users into Supabase auth + profiles
```

Supabase CLI (for schema changes):
```bash
supabase link --project-ref <PROJECT_REF>
supabase db push     # Apply migrations
```

## Architecture

### Stack
- **Next.js 15** (App Router, TypeScript strict mode, typed routes enabled)
- **React 19** with server/client component separation
- **Supabase** (Auth + PostgreSQL) via `@supabase/ssr` for server-side auth
- **Vitest** for unit tests (Node environment, `*.test.ts` files)
- No Tailwind — custom CSS only (`src/app/globals.css`, ~13KB with CSS custom properties)

### Path Alias
`@/*` maps to `src/*` (configured in `tsconfig.json`).

### Auth & Authorization

Three Supabase clients for different contexts:
- `src/lib/supabaseClient.ts` — browser client
- `src/lib/supabaseServer.ts` — server components/routes
- `src/lib/supabaseAdmin.ts` — service role (admin operations, RPC calls)

Auth flow:
1. `src/middleware.ts` — redirects unauthenticated requests to `/login`
2. Server pages call `requireAuth()` (`src/lib/auth.ts`) to get the active `Profile`
3. API routes call `requireApiUser()` (`src/lib/apiAuth.ts`)
4. Role checks use helpers in `src/lib/authz.ts` (`canManageProducts`, `canVoidInvoices`, etc.)

Roles: `manager` | `sales`. Managers can manage products, void invoices, edit payments. Sales can create invoices.

### Business Logic Lives in the Database

Complex operations are PL/pgSQL functions in `supabase/migrations/20260220221500_init_mvp.sql`:
- `create_invoice(...)` — validates items, creates invoice + line items, deducts stock, logs `stock_movements`
- `void_invoice(...)` — manager-only, restores stock and logs `void_reversal` movements
- `update_invoice_payment(...)` — manager-only, recalculates `payment_status`
- `dashboard_metrics()` — returns KPIs (invoked by `/api/reports/dashboard`)
- `low_stock_items()` — returns products below threshold (invoked by `/api/alerts/low-stock`)

API routes call these via the admin Supabase client `.rpc()`. Never write invoices/stock directly from API routes — always go through the RPC functions.

### Route Structure

```
src/app/
  (auth)/login/          # Public login page
  (dashboard)/dashboard/ # Protected shell with sidebar nav
    page.tsx             # KPIs + low-stock preview
    products/            # CRUD (managers only for create/edit)
    invoices/            # List, create, detail
    low-stock/           # Full low-stock list
  api/
    invoices/            # POST create, PATCH payment, POST void
    products/            # POST create, GET list, PATCH update
    alerts/low-stock/    # GET low stock
    reports/dashboard/   # GET metrics
```

### Key Business Rules
- Stock can go negative (no hard floor)
- Default low-stock threshold: 3 units (configurable per-product or via global `settings` table)
- Invoice numbers: `INV-YYYYMMDD-000001` (generated by `next_invoice_number()`)
- Payment status: `paid` | `partially_paid` | `unpaid` (auto-derived from `paid_amount` vs `total`)

### Styling
All styles in `src/app/globals.css`. Key CSS variables:
- `--bg-base`, `--bg-surface`, `--bg-surface-2` — background layers
- `--accent-500` — primary blue (`#1a63d1`)
- `--success-500`, `--warning-500`, `--danger-500` — status colors
- `--text-strong`, `--text-body`, `--text-muted` — text hierarchy

Fonts: Manrope (display/headings) + Source Sans 3 (body), loaded via `next/font/google` in `src/app/layout.tsx`.

## Environment Variables

```
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=       # Server-only, never expose to client
APP_CURRENCY=EGP
APP_TIMEZONE=Africa/Cairo
MYST_SEED_PASSWORD=              # Only needed for seed:users script
```
